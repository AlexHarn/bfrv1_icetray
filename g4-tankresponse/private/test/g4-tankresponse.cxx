#include <I3Test.h>
#include <icetray/I3Logging.h>

#include <cstdlib>
#include <iostream>
#include <map>
#include <set>

#include "globals.hh"
#include <G4TessellatedSolid.hh>
#include <G4ThreeVector.hh>

#include <g4-tankresponse/g4classes/G4Delaunay.h>

TEST_GROUP(g4_tankresponse);
using std::cout;
using std::endl;
using std::string;
using std::vector;
using std::map;
using std::pair;
using std::set;
using std::min;
using std::max;

namespace AllIceTopPoints {
  struct Point {
    double x;
    double y;
    double z;
  };

  Point points[486] = {
    {-146090.76, -478466.25, 3004.95}, {-136887.32, -482377.36, 3004.95}, {-138101.92, -472451.39, 3004.95}, {-124904.24, -475873.75, 2984.93},
    {-134107.68, -471962.64, 2984.93}, {-132893.08, -481888.60, 2984.93}, { -32332.37, -467962.66, 3175.00}, { -22406.40, -466748.11, 3175.00},
    { -28421.23, -458759.24, 3175.00}, { -15782.63, -455502.35, 3044.99}, { -25708.60, -456716.90, 3044.99}, { -19693.77, -464705.77, 3044.99},
    {  99984.50, -439790.72, 2964.99}, { 109430.51, -443072.94, 2964.99}, { 107549.99, -433251.35, 2964.99}, { 120935.50, -435779.27, 3144.97},
    { 111489.49, -432497.06, 3144.97}, { 113370.01, -442318.65, 3144.97}, { 211530.99, -437209.54, 3124.91}, { 220501.03, -432789.32, 3124.91},
    { 212187.98, -427231.15, 3124.91}, { 223114.01, -419885.46, 3224.92}, { 214143.97, -424305.68, 3224.92}, { 222457.02, -429863.85, 3224.92},
    { 350828.45, -397979.94, 4144.97}, { 359355.82, -403203.35, 4144.97}, { 359615.74, -393206.73, 4144.97}, { 371986.55, -398530.07, 4284.90},
    { 363459.18, -393306.66, 4284.90}, { 363199.26, -403303.28, 4284.90}, {-235522.78, -393115.19, 2734.93}, {-225737.42, -391054.40, 2734.93},
    {-232414.80, -383610.43, 2734.93}, {-219887.23, -379089.82, 2815.01}, {-229672.58, -381150.62, 2815.01}, {-222995.21, -388594.58, 2815.01},
    { -90729.83, -358087.15, 2664.99}, { -83850.35, -365344.75, 2664.99}, { -81004.82, -355758.14, 2664.99}, { -70530.17, -364082.87, 2764.96},
    { -77409.65, -356825.27, 2764.96}, { -80255.17, -366411.87, 2764.96}, {  19548.44, -344072.80, 2794.93}, {  29256.35, -346472.06, 2794.93},
    {  26480.21, -336865.14, 2794.93}, {  40071.56, -338142.19, 2874.91}, {  30363.65, -335742.93, 2874.91}, {  33139.79, -345349.86, 2874.91},
    { 136302.67, -359107.92, 3065.01}, { 140114.85, -349863.07, 3065.01}, { 130202.48, -351184.05, 3065.01}, { 133457.33, -337757.09, 3044.99},
    { 129645.15, -347001.94, 3044.99}, { 139557.52, -345680.96, 3044.99}, { 273375.40, -299835.18, 3104.93}, { 281443.67, -305743.06, 3104.93},
    { 282525.91, -295801.79, 3104.93}, { 294499.59, -302134.83, 3195.01}, { 286431.32, -296226.95, 3195.01}, { 285349.08, -306168.21, 3195.01},
    { 381796.00, -294162.63, 4324.92}, { 391587.33, -292130.41, 4324.92}, { 384931.70, -284666.98, 4324.92}, { 397759.01, -279927.38, 4314.91},
    { 387967.68, -281959.60, 4314.91}, { 394623.30, -289423.03, 4314.91}, {-265007.71, -299267.55, 3014.96}, {-271003.10, -307271.00, 3014.96},
    {-261074.21, -308461.44, 3014.96}, {-267557.30, -320532.45, 3004.95}, {-261561.90, -312529.00, 3004.95}, {-271490.79, -311338.56, 3004.95},
    {-187488.28, -270547.70, 2945.01}, {-177528.41, -271442.63, 2945.01}, {-181733.31, -262369.66, 2945.01}, {-167776.72, -261412.29, 2904.98},
    {-177736.59, -260517.36, 2904.98}, {-173531.69, -269590.33, 2904.98}, { -45849.00, -241270.39, 2334.91}, { -39144.87, -248690.26, 2334.91},
    { -36071.13, -239174.37, 2334.91}, { -25496.00, -247844.62, 2435.00}, { -32200.13, -240424.74, 2435.00}, { -35273.87, -249940.63, 2435.00},
    {  60964.12, -229170.38, 2385.00}, {  70820.32, -230860.10, 2385.00}, {  67355.56, -221479.51, 2385.00}, {  81095.88, -221734.62, 2374.95},
    {  71239.68, -220044.90, 2374.95}, {  74704.44, -229425.49, 2374.95}, { 204495.42, -184430.67, 2805.00}, { 212517.63, -190400.95, 2805.00},
    { 213676.94, -180468.38, 2805.00}, { 225774.57, -186914.33, 2925.00}, { 217752.37, -180944.05, 2925.00}, { 216593.06, -190876.63, 2925.00},
    { 315121.71, -232946.03, 2945.01}, { 313528.01, -223073.85, 2945.01}, { 305775.29, -229390.12, 2945.01}, { 301628.29, -216383.96, 2784.98},
    { 303221.99, -226256.15, 2784.98}, { 310974.71, -219939.87, 2784.98}, { 446553.60, -215809.40, 6254.98}, { 441995.17, -206908.80, 6254.98},
    { 436566.24, -215306.82, 6254.98}, { 428116.40, -203890.60, 6324.92}, { 432674.83, -212791.20, 6324.92}, { 438103.76, -204393.18, 6324.92},
    {-393468.44, -198465.25, 2974.92}, {-383588.73, -196918.81, 2974.92}, {-389867.85, -189135.96, 2974.92}, {-376821.57, -185034.76, 2974.92},
    {-386701.27, -186581.20, 2974.92}, {-380422.16, -194364.05, 2974.92}, {-227926.61, -170535.21, 2914.99}, {-228766.50, -180499.88, 2914.99},
    {-219716.90, -176244.91, 2914.99}, {-218913.39, -189704.79, 2974.92}, {-218073.51, -179740.12, 2974.92}, {-227123.11, -183995.09, 2974.92},
    {-105017.90, -150592.66, 2984.93}, {-105807.57, -160561.43, 2984.93}, { -96779.53, -156260.91, 2984.93}, { -95822.10, -169897.35, 2945.01},
    { -95032.43, -159928.58, 2945.01}, {-104060.47, -164229.09, 2945.01}, {   9116.79, -125551.07, 2804.99}, {  12337.30, -135018.29, 2804.99},
    {  18925.90, -127495.63, 2804.99}, {  25293.21, -139718.92, 2534.99}, {  22072.70, -130251.70, 2534.99}, {  15484.10, -137774.36, 2534.99},
    { 120008.67, -104699.06, 2444.93}, { 127077.64, -111772.22, 2444.93}, { 129668.69, -102113.73, 2444.93}, { 140536.33, -110205.94, 2594.94},
    { 133467.36, -103132.78, 2594.94}, { 130876.31, -112791.27, 2594.94}, { 224270.22,  -99482.10, 3964.91}, { 234144.04,  -97898.55, 3964.91},
    { 227835.74,  -90139.35, 3964.91}, { 240609.78,  -86197.90, 3964.91}, { 230735.96,  -87781.45, 3964.91}, { 237044.26,  -95540.65, 3964.91},
    { 368223.46, -118835.03, 6174.93}, { 363693.79, -109919.76, 6174.93}, { 358237.78, -118300.21, 6174.93}, { 349906.54, -106909.97, 5814.98},
    { 354436.22, -115825.24, 5814.98}, { 359892.23, -107444.79, 5814.98}, { 526787.48,  -62472.74, 8084.97}, { 517921.76,  -67098.64, 8084.97},
    { 526360.77,  -72463.63, 8084.97}, { 515042.53,  -80947.26, 8044.94}, { 523908.26,  -76321.37, 8044.94}, { 515469.25,  -70956.37, 8044.94},
    {-458391.85,  -88242.22, 2935.00}, {-449853.38,  -93447.46, 2935.00}, {-449614.75,  -83450.31, 2935.00}, {-437003.15,  -88752.78, 2894.97},
    {-445541.62,  -83547.54, 2894.97}, {-445780.26,  -93544.69, 2894.97}, {-306931.21,  -73225.91, 2995.00}, {-307933.23,  -83175.58, 2995.00},
    {-298815.55,  -79068.52, 2995.00}, {-298188.78,  -92634.10, 2934.93}, {-297186.77,  -82684.43, 2934.93}, {-306304.44,  -86791.49, 2934.93},
    {-183616.20,  -53575.68, 3244.96}, {-184255.50,  -63555.22, 3244.96}, {-175293.31,  -59119.10, 3244.96}, {-173808.80,  -73389.32, 3314.96},
    {-173169.50,  -63409.78, 3314.96}, {-182131.69,  -67845.90, 3314.96}, { -92107.63,  -31854.68, 3774.92}, { -82793.02,  -35493.11, 3774.92},
    { -84299.35,  -25607.21, 3774.92}, { -70782.38,  -28605.32, 3974.92}, { -80096.98,  -24966.89, 3974.92}, { -78590.65,  -34852.79, 3974.92},
    {  42490.02,  -60149.29, 4404.98}, {  37323.09,  -51587.58, 4404.98}, {  32491.90,  -60343.13, 4404.98}, {  24124.98,  -50015.71, 4504.95},
    {  29291.91,  -58577.42, 4504.95}, {  34123.11,  -49821.87, 4504.95}, { 153899.65,  -35916.67, 4354.93}, { 153406.85,  -25928.82, 4354.93},
    { 145003.52,  -31349.52, 4354.93}, { 142215.36,  -17803.33, 4065.01}, { 142708.16,  -27791.18, 4065.01}, { 151111.49,  -22370.48, 4065.01},
    { 318916.97,    1197.76, 7574.94}, { 310261.50,   -3810.52, 7574.94}, { 318926.54,   -8802.24, 7574.94}, { 308193.03,  -17417.76, 7434.90},
    { 316848.50,  -12409.48, 7434.90}, { 308183.46,   -7417.76, 7434.90}, { 438061.51,    8816.06, 8064.99}, { 429201.46,    4179.29, 8064.99},
    { 437647.04,   -1175.35, 8064.99}, { 426473.50,   -9461.06, 7944.99}, { 435333.54,   -4824.29, 7944.99}, { 426887.97,     530.35, 7944.99},
    { 535688.42,   18232.79, 7884.91}, { 530433.80,   26740.96, 7884.91}, { 525692.81,   17936.25, 7884.91}, { 516941.59,   28327.21, 7875.01},
    { 522196.20,   19819.04, 7875.01}, { 526937.19,   28623.75, 7875.01}, {-509422.60,    4293.36, 2644.99}, {-509923.64,   -5694.08, 2644.99},
    {-501023.74,   -1134.27, 2644.99}, {-499592.40,  -14893.36, 2734.91}, {-499091.36,   -4905.92, 2734.91}, {-507991.26,   -9465.73, 2734.91},
    {-386183.79,   23447.61, 3134.96}, {-386663.06,   13459.10, 3134.96}, {-377773.13,   18038.29, 3134.96}, {-376461.20,    4572.39, 3065.01},
    {-375981.93,   14560.90, 3065.01}, {-384871.86,    9981.71, 3065.01}, {-262738.13,   43829.36, 3055.00}, {-263556.03,   33862.86, 3055.00},
    {-254515.85,   38137.79, 3055.00}, {-253311.88,   23895.64, 2935.00}, {-252493.98,   33862.14, 2935.00}, {-261534.17,   29587.21, 2935.00},
    {-129342.55,   43632.24, 3704.96}, {-137181.89,   37423.80, 3704.96}, {-127885.56,   33738.95, 3704.96}, {-137097.45,   24067.76, 3624.95},
    {-129258.11,   30276.20, 3624.95}, {-138554.45,   33961.05, 3624.95}, { -38476.96,   37074.41, 4425.01}, { -42550.18,   46207.26, 4425.01},
    { -48422.85,   38113.33, 4425.01}, { -55803.03,   49645.59, 4264.99}, { -51729.82,   40512.74, 4264.99}, { -45857.15,   48606.68, 4264.99},
    {  73927.16,   61658.61, 4634.91}, {  74535.64,   71640.08, 4634.91}, {  65587.19,   67176.30, 4634.91}, {  64497.84,   80561.39, 4675.01},
    {  63889.36,   70579.92, 4675.01}, {  72837.81,   75043.70, 4675.01}, { 174073.46,  108952.18, 6294.94}, { 176835.45,  118563.18, 6294.94},
    { 167131.08,  116149.64, 6294.94}, { 168881.54,  129827.82, 6394.96}, { 166119.55,  120216.81, 6394.96}, { 175823.92,  122630.36, 6394.96},
    { 370324.46,  148390.98, 8625.01}, { 365692.27,  157253.42, 8625.01}, { 360333.27,  148810.60, 8625.01}, { 352170.54,  159914.02, 8474.91},
    { 356802.73,  151051.58, 8474.91}, { 362161.73,  159494.40, 8474.91}, { 494288.93,  142637.94, 8304.94}, { 490750.98,  133284.70, 8304.94},
    { 500620.09,  134897.37, 8304.94}, { 497696.07,  121787.07, 8304.93}, { 501234.02,  131140.30, 8304.93}, { 491364.91,  129527.63, 8304.93},
    { 608378.88,  151446.00, 8494.92}, { 598634.37,  149199.98, 8494.92}, { 605451.74,  141884.00, 8494.92}, { 592521.12,  136668.99, 8464.95},
    { 602265.62,  138915.02, 8464.95}, { 595448.25,  146231.00, 8464.95}, {-456059.50,  107284.82, 3045.01}, {-462191.26,   99385.36, 3045.01},
    {-452284.25,   98024.83, 3045.01}, {-459050.50,   85505.18, 2884.96}, {-452918.74,   93404.64, 2884.96}, {-462825.75,   94765.18, 2884.96},
    {-332448.27,  126358.96, 3734.93}, {-338588.62,  118466.17, 3734.93}, {-328683.08,  117094.87, 3734.93}, {-335306.72,  105711.04, 3754.97},
    {-329166.37,  113603.83, 3754.97}, {-339071.91,  114975.13, 3754.97}, {-208848.44,  144587.32, 3975.02}, {-215600.35,  137210.89, 3975.02},
    {-205836.22,  135051.78, 3975.02}, {-213361.56,  124177.67, 3914.97}, {-206609.65,  131554.10, 3914.97}, {-216373.78,  133713.21, 3914.97},
    {-117199.46,  132994.55, 3924.91}, {-120974.14,  142254.77, 3924.91}, {-127106.39,  134355.69, 3924.91}, {-133965.54,  146010.46, 3995.01},
    {-130190.85,  136750.23, 3995.01}, {-124058.61,  144649.32, 3995.01}, {  26901.27,  156772.57, 4914.91}, {  17442.69,  160018.35, 4914.91},
    {  19361.04,  150204.08, 4914.91}, {   5643.73,  152617.43, 4874.95}, {  15102.32,  149371.65, 4874.95}, {  13183.96,  159185.92, 4874.95},
    { 138630.37,  173173.77, 6164.95}, { 131612.73,  180297.86, 6164.95}, { 128951.90,  170658.36, 6164.95}, { 118424.63,  178751.23, 5925.02},
    { 125442.27,  171627.14, 5925.02}, { 128103.10,  181266.64, 5925.02}, { 253236.16,  190931.94, 7785.00}, { 249641.40,  200263.49, 7785.00},
    { 243357.43,  192484.56, 7785.00}, { 236708.83,  204283.05, 7564.91}, { 240303.59,  194951.51, 7564.91}, { 246587.57,  202730.44, 7564.91},
    { 405229.67,  223814.59, 8304.97}, { 395263.79,  222989.20, 8304.97}, { 400961.54,  214771.19, 8304.97}, { 388175.33,  211990.41, 8404.96},
    { 398141.21,  212815.79, 8404.96}, { 392443.46,  221033.80, 8404.96}, { 529738.05,  245190.71, 8504.98}, { 519858.51,  243643.23, 8504.98},
    { 526138.43,  235861.04, 8504.98}, { 513136.95,  231794.28, 8465.02}, { 523016.49,  233341.76, 8465.02}, { 516736.57,  241123.95, 8465.02},
    {-418280.13,  236799.19, 3674.92}, {-419722.97,  226903.83, 3674.92}, {-410431.91,  230601.97, 3674.92}, {-410369.86,  216925.80, 3664.93},
    {-408927.03,  226821.16, 3664.93}, {-418218.08,  223123.02, 3664.93}, {-286479.61,  238046.87, 3904.98}, {-294459.73,  232020.46, 3904.98},
    {-285250.64,  228122.68, 3904.98}, {-294675.39,  218683.13, 3904.96}, {-286695.27,  224709.54, 3904.96}, {-295904.35,  228607.33, 3904.96},
    {-197246.18,  231294.10, 4054.92}, {-200719.82,  240671.41, 4054.92}, {-207103.98,  232974.50, 4054.92}, {-213638.81,  244890.89, 4014.95},
    {-210165.18,  235513.59, 4014.95}, {-203781.01,  243210.50, 4014.95}, { -47974.93,  257829.81, 4604.98}, { -57859.19,  259346.87, 4604.98},
    { -54230.88,  250028.32, 4604.98}, { -66915.07,  250455.20, 4604.91}, { -57030.81,  248938.13, 4604.91}, { -60659.12,  258256.68, 4604.91},
    {  70475.79,  273298.64, 5895.01}, {  61174.67,  276971.39, 5895.01}, {  62644.53,  267080.01, 5895.01}, {  49599.21,  270196.37, 5724.91},
    {  58900.33,  266523.62, 5724.91}, {  57430.47,  276415.00, 5724.91}, { 154380.96,  297243.89, 7294.94}, { 158171.66,  306497.57, 7294.94},
    { 148262.39,  305153.57, 7294.94}, { 151569.05,  317976.13, 7164.94}, { 147778.34,  308722.45, 7164.94}, { 157687.62,  310066.44, 7164.94},
    { 324898.40,  319911.00, 8325.02}, { 314899.66,  319751.78, 8325.02}, { 320036.92,  311172.24, 8325.02}, { 307626.60,  309569.01, 8344.92},
    { 317625.33,  309728.23, 8344.92}, { 312488.08,  318307.77, 8344.92}, { 445825.26,  335106.22, 8394.99}, { 436080.25,  337350.08, 8394.99},
    { 439009.52,  327788.73, 8394.99}, { 425514.74,  328883.79, 8664.95}, { 435259.74,  326639.93, 8664.95}, { 432330.48,  336201.28, 8664.95},
    {-398765.40,  308879.53, 3844.98}, {-402964.86,  317955.03, 3844.98}, {-408724.74,  309780.44, 3844.98}, {-415584.60,  320730.48, 3694.91},
    {-411385.15,  311654.99, 3694.91}, {-405625.27,  319829.57, 3694.91}, {-274903.22,  327861.26, 4064.93}, {-279163.42,  336908.40, 4064.93},
    {-284868.37,  328695.39, 4064.93}, {-292016.79,  339748.76, 4094.96}, {-287756.60,  330701.62, 4094.96}, {-282051.64,  338914.63, 4094.96},
    {-157678.20,  350066.85, 4415.01}, {-159584.12,  359883.54, 4415.01}, {-167132.67,  353324.62, 4415.01}, {-171481.80,  365953.16, 4514.93},
    {-169575.87,  356136.46, 4514.93}, {-162027.33,  362695.39, 4514.93}, {  -7036.11,  371834.73, 5574.94}, { -16740.53,  374248.09, 5574.94},
    { -13978.36,  364637.14, 5574.94}, { -27458.89,  365965.26, 5745.02}, { -17754.47,  363551.89, 5745.02}, { -20516.64,  373162.84, 5745.02},
    { 127440.19,  405148.93, 7024.97}, { 117885.71,  402197.33, 7024.97}, { 125219.11,  395398.71, 7024.97}, { 112724.81,  389276.06, 7044.97},
    { 122279.29,  392227.65, 7044.97}, { 114945.90,  399026.28, 7044.97}, { 211301.05,  408317.10, 7784.96}, { 210335.48,  418270.37, 7784.96},
    { 202198.47,  412457.53, 7784.96}, { 198673.95,  425992.90, 7724.95}, { 199639.52,  416039.62, 7724.95}, { 207776.52,  421852.47, 7724.95},
    { 373887.50,  434531.46, 8564.92}, { 363977.91,  433189.85, 8564.92}, { 370094.57,  425278.69, 8564.92}, { 357522.50,  421878.55, 8524.94},
    { 367432.10,  423220.15, 8524.94}, { 361315.44,  431131.31, 8524.94}, {-347102.53,  419676.82, 4074.97}, {-353842.26,  427064.38, 4074.97},
    {-356870.21,  417533.82, 4074.97}, {-366747.46,  425918.20, 4144.99}, {-360007.73,  418530.64, 4144.99}, {-356979.79,  428061.20, 4144.99},
    {-238522.09,  448609.20, 4354.99}, {-239449.28,  458566.13, 4354.99}, {-247608.63,  452784.69, 4354.99}, {-250947.91,  466145.80, 4344.90},
    {-250020.72,  456188.88, 4344.90}, {-241861.37,  461970.31, 4344.90}, { -82300.40,  470755.67, 5364.94}, { -92165.92,  472390.17, 5364.94},
    { -88648.68,  463029.13, 5364.94}, {-102504.60,  463164.31, 5234.94}, { -92639.08,  461529.81, 5234.94}, { -96156.32,  470890.85, 5234.94},
    {   4523.50,  489375.16, 6055.00}, {   5445.41,  499332.57, 6055.00}, {  -3638.92,  495152.26, 6055.00}, {  -4433.50,  508839.84, 6034.99},
    {  -5355.41,  498882.43, 6034.99}, {   3728.92,  503062.73, 6034.99}
  };
}

TEST(G4Delaunay)
{
  const double m = 1000.;

  G4Delaunay delaunay;
  const size_t nPoints = 438;

  for (size_t i = 0; i < nPoints; ++i) {
    delaunay.AddPoint(AllIceTopPoints::points[i].x, AllIceTopPoints::points[i].y, AllIceTopPoints::points[i].z);
  }
  G4TessellatedSolid* solidSnow = new G4TessellatedSolid("solid_snow");
  delaunay.BuildSolid(solidSnow, 50.0*m, 100.0*m);

  ENSURE_EQUAL(solidSnow->GetNumberOfFacets(), 1019);
  ENSURE_DISTANCE(solidSnow->GetSurfaceArea(), 2.88444e12, 1e8)
  //ENSURE_EQUAL(solidSnow->GetCubicVolume(), 0.)
  ENSURE_EQUAL(solidSnow->Inside(G4ThreeVector(-11793., -70591., 7945.)), kOutside);
  ENSURE_EQUAL(solidSnow->Inside(G4ThreeVector(-11793., -70591., 7945.)), kOutside);
  ENSURE_EQUAL(solidSnow->Inside(G4ThreeVector(-11791., -70586., 3184.)), kInside);
  // ENSURE_EQUAL(solidSnow->Inside(G4ThreeVector()), );
}
